{% extends "layout.html" %}

{% block title %}Property Valuation - TerraLegislativePulse{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>Property Valuation</h1>
            <p class="lead">Calculate property values using multiple approaches in accordance with Washington State standards</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Valuation Form -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Valuation Form</h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="parcel_id" class="form-label">Parcel ID</label>
                            <input type="text" class="form-control" id="parcel_id" name="parcel_id" 
                                   value="{{ property_data.parcel_id if property_data else '' }}"
                                   placeholder="Format: 12345678-123" required>
                            <div class="form-text">Must match Washington State format (8 digits, hyphen, 3 digits)</div>
                            <div class="invalid-feedback">
                                Please provide a valid parcel ID.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="property_address" class="form-label">Property Address</label>
                            <input type="text" class="form-control" id="property_address" name="property_address"
                                   value="{{ property_data.property_address if property_data else '' }}"
                                   placeholder="123 Example St, Kennewick, WA" required>
                            <div class="invalid-feedback">
                                Please provide a property address.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="property_class" class="form-label">Property Class</label>
                            <select class="form-select" id="property_class" name="property_class" required>
                                <option value="" selected disabled>Select property class</option>
                                {% for class_name in property_classes %}
                                <option value="{{ class_name }}" {% if property_data and property_data.property_class == class_name %}selected{% endif %}>
                                    {{ class_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="class_codes_display" class="form-text d-none"></div>
                            <div class="invalid-feedback">
                                Please select a property class.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="assessed_value" class="form-label">Current Assessed Value</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="assessed_value" name="assessed_value"
                                       value="{{ property_data.assessed_value if property_data else '' }}"
                                       min="1000" step="0.01" required>
                            </div>
                            <div class="form-text">Base value for calculations</div>
                            <div class="invalid-feedback">
                                Please provide a valid assessed value.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="assessment_year" class="form-label">Assessment Year</label>
                            <input type="number" class="form-control" id="assessment_year" name="assessment_year"
                                   value="{{ property_data.assessment_year if property_data else '2025' }}"
                                   min="2020" max="2026" required>
                            <div class="invalid-feedback">
                                Please provide a valid assessment year (2020-2026).
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="year_built" class="form-label">Year Built</label>
                            <input type="number" class="form-control" id="year_built" name="year_built"
                                   value="{{ property_data.year_built if property_data else '' }}"
                                   min="1900" max="2025">
                            <div class="form-text">Required for cost approach</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="building_area" class="form-label">Building Area (sq ft)</label>
                            <input type="number" class="form-control" id="building_area" name="building_area"
                                   value="{{ property_data.building_area if property_data else '' }}"
                                   min="0" step="0.01">
                            <div class="form-text">Required for cost and income approaches</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="land_area" class="form-label">Land Area (sq ft)</label>
                            <input type="number" class="form-control" id="land_area" name="land_area"
                                   value="{{ property_data.land_area if property_data else '' }}"
                                   min="0" step="0.01">
                            <div class="form-text">Required for cost approach</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Valuation Approach</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="valuation_approach" id="approach_market" value="market" 
                                       {% if selected_approach == 'market' %}checked{% endif %} required>
                                <label class="form-check-label" for="approach_market">
                                    Market Comparison Approach
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="valuation_approach" id="approach_cost" value="cost"
                                       {% if selected_approach == 'cost' %}checked{% endif %}>
                                <label class="form-check-label" for="approach_cost">
                                    Cost Approach
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="valuation_approach" id="approach_income" value="income"
                                       {% if selected_approach == 'income' %}checked{% endif %}>
                                <label class="form-check-label" for="approach_income">
                                    Income Approach (Commercial Properties)
                                </label>
                            </div>
                            <div class="invalid-feedback">
                                Please select a valuation approach.
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calculator me-2"></i> Calculate Property Value
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Valuation Results -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Valuation Results</h5>
                </div>
                <div class="card-body">
                    {% if valuation_results %}
                        <!-- Market Approach Results -->
                        {% if 'market_value' in valuation_results %}
                            <div class="mb-3">
                                <h5>
                                    <i class="fas fa-chart-line text-primary me-2"></i> Market Comparison Approach
                                </h5>
                                <div class="chart-container">
                                    <canvas id="marketApproachChart"></canvas>
                                </div>
                                <div class="table-responsive mt-3">
                                    <table class="table table-bordered">
                                        <tr class="table-primary">
                                            <th>Final Market Value:</th>
                                            <td class="text-end fw-bold">${{ "{:,.2f}".format(valuation_results.market_value) }}</td>
                                        </tr>
                                        <tr>
                                            <th>Base Value:</th>
                                            <td class="text-end">${{ "{:,.2f}".format(valuation_results.base_value) }}</td>
                                        </tr>
                                        <tr>
                                            <th>Property Class:</th>
                                            <td>{{ valuation_results.property_class }}</td>
                                        </tr>
                                        <tr>
                                            <th>Location:</th>
                                            <td>{{ valuation_results.property_city }}</td>
                                        </tr>
                                        <tr>
                                            <th colspan="2" class="table-secondary">Value Adjustment Factors</th>
                                        </tr>
                                        <tr>
                                            <th>Market Multiplier:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.market_multiplier) }} ({{ "{:.1f}%".format((valuation_results.market_multiplier-1)*100) }})</td>
                                        </tr>
                                        <tr>
                                            <th>Location Multiplier:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.location_multiplier) }} ({{ "{:.1f}%".format((valuation_results.location_multiplier-1)*100) }})</td>
                                        </tr>
                                        {% if 'age_adjustment' in valuation_results %}
                                        <tr>
                                            <th>Age Adjustment:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.age_adjustment) }} ({{ "{:.1f}%".format((valuation_results.age_adjustment-1)*100) }})</td>
                                        </tr>
                                        {% endif %}
                                        {% if 'size_adjustment' in valuation_results %}
                                        <tr>
                                            <th>Size Adjustment:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.size_adjustment) }} ({{ "{:.1f}%".format((valuation_results.size_adjustment-1)*100) }})</td>
                                        </tr>
                                        {% endif %}
                                        {% if 'feature_adjustment' in valuation_results %}
                                        <tr>
                                            <th>Feature Adjustment:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.feature_adjustment) }} ({{ "{:.1f}%".format((valuation_results.feature_adjustment-1)*100) }})</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <th>Confidence Score:</th>
                                            <td class="text-end">{{ valuation_results.confidence_score * 100 }}%</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                {% if valuation_results.comparable_properties %}
                                <div class="mt-4">
                                    <h6 class="mb-3">Comparable Properties</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Property</th>
                                                    <th class="text-end">Base Value</th>
                                                    <th class="text-end">Adjustment</th>
                                                    <th class="text-end">Adjusted Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for comparable in valuation_results.comparable_properties %}
                                                <tr>
                                                    <td>
                                                        {{ comparable.address }}
                                                        {% if comparable.year_built %}
                                                        <small class="text-muted d-block">Built {{ comparable.year_built }}</small>
                                                        {% endif %}
                                                        {% if comparable.building_area %}
                                                        <small class="text-muted d-block">{{ "{:,.0f}".format(comparable.building_area) }} sq ft</small>
                                                        {% endif %}
                                                        {% if comparable.bedrooms and comparable.bathrooms %}
                                                        <small class="text-muted d-block">{{ comparable.bedrooms }} bed/{{ comparable.bathrooms }} bath</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">${{ "{:,.2f}".format(comparable.value) }}</td>
                                                    <td class="text-end">{{ "{:.2f}".format(comparable.adjustment_factor) }}</td>
                                                    <td class="text-end">${{ "{:,.2f}".format(comparable.adjusted_value) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        
                        <!-- Cost Approach Results -->
                        {% elif 'cost_value' in valuation_results %}
                            <div class="mb-3">
                                <h5>
                                    <i class="fas fa-tools text-warning me-2"></i> Cost Approach
                                </h5>
                                <div class="chart-container">
                                    <canvas id="costApproachChart"></canvas>
                                </div>
                                <div class="table-responsive mt-3">
                                    <table class="table table-bordered">
                                        <tr class="table-warning">
                                            <th>Final Cost Value:</th>
                                            <td class="text-end fw-bold">${{ "{:,.2f}".format(valuation_results.cost_value) }}</td>
                                        </tr>
                                        <tr>
                                            <th>Property Class:</th>
                                            <td>{{ valuation_results.property_class }}</td>
                                        </tr>
                                        <tr>
                                            <th>Location:</th>
                                            <td>{{ valuation_results.property_city }}</td>
                                        </tr>
                                        <tr>
                                            <th>Building Age:</th>
                                            <td>{{ valuation_results.building_age }} years (built {{ 2025 - valuation_results.building_age }})</td>
                                        </tr>
                                        <tr>
                                            <th colspan="2" class="table-secondary">Cost Components</th>
                                        </tr>
                                        <tr>
                                            <th>Replacement Cost:</th>
                                            <td class="text-end">${{ "{:,.2f}".format(valuation_results.replacement_cost) }} 
                                                <small class="text-muted">({{ "{:,.0f}".format(valuation_results.building_area) }} sq ft @ ${{ "{:.2f}".format(valuation_results.replacement_cost_per_sqft) }}/sq ft)</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Depreciated Cost:</th>
                                            <td class="text-end">${{ "{:,.2f}".format(valuation_results.depreciated_cost) }}
                                                <small class="text-muted">({{ "{:.1f}".format(valuation_results.depreciation_rate * 100) }}% depreciation)</small>
                                            </td>
                                        </tr>
                                        {% if 'functional_obsolescence' in valuation_results and valuation_results.functional_obsolescence > 0 %}
                                        <tr>
                                            <th>Functional Obsolescence:</th>
                                            <td class="text-end">- ${{ "{:,.2f}".format(valuation_results.functional_obsolescence) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if 'external_obsolescence' in valuation_results and valuation_results.external_obsolescence > 0 %}
                                        <tr>
                                            <th>External Obsolescence:</th>
                                            <td class="text-end">- ${{ "{:,.2f}".format(valuation_results.external_obsolescence) }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <th>Land Value:</th>
                                            <td class="text-end">${{ "{:,.2f}".format(valuation_results.land_value) }}
                                                <small class="text-muted">({{ "{:,.0f}".format(valuation_results.land_area) }} sq ft @ ${{ "{:.2f}".format(valuation_results.land_value_per_sqft) }}/sq ft)</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th colspan="2" class="table-secondary">Quality Factors</th>
                                        </tr>
                                        {% if 'quality_factor' in valuation_results %}
                                        <tr>
                                            <th>Quality Factor:</th>
                                            <td class="text-end">{{ "{:.2f}".format(valuation_results.quality_factor) }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <th>Property Details:</th>
                                            <td>
                                                <div>Building Area: {{ "{:,.0f}".format(valuation_results.building_area) }} sq ft</div>
                                                <div>Land Area: {{ "{:,.0f}".format(valuation_results.land_area) }} sq ft</div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Confidence Score:</th>
                                            <td class="text-end">{{ valuation_results.confidence_score * 100 }}%</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        
                        <!-- Income Approach Results -->
                        {% elif 'income_value' in valuation_results %}
                            {% if valuation_results.income_value %}
                                <div class="mb-3">
                                    <h5>
                                        <i class="fas fa-money-bill-wave text-success me-2"></i> Income Approach
                                    </h5>
                                    <div class="chart-container">
                                        <canvas id="incomeApproachChart"></canvas>
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-bordered">
                                            <tr class="table-success">
                                                <th>Final Income Value:</th>
                                                <td class="text-end fw-bold">${{ "{:,.2f}".format(valuation_results.income_value) }}</td>
                                            </tr>
                                            <tr>
                                                <th>Property Class:</th>
                                                <td>{{ valuation_results.property_class }}</td>
                                            </tr>
                                            <tr>
                                                <th>Location:</th>
                                                <td>{{ valuation_results.property_city }}</td>
                                            </tr>
                                            <tr>
                                                <th>Building Age:</th>
                                                <td>{{ valuation_results.building_age }} years (built {{ 2025 - valuation_results.building_age }})</td>
                                            </tr>
                                            <tr>
                                                <th colspan="2" class="table-secondary">Income Components</th>
                                            </tr>
                                            <tr>
                                                <th>Potential Gross Income:</th>
                                                <td class="text-end">${{ "{:,.2f}".format(valuation_results.potential_gross_income) }} 
                                                    <small class="text-muted">({{ "{:,.0f}".format(valuation_results.building_area) }} sq ft @ ${{ "{:.2f}".format(valuation_results.rental_rate_per_sqft) }}/sq ft)</small>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Vacancy & Collection Loss:</th>
                                                <td class="text-end">- ${{ "{:,.2f}".format(valuation_results.potential_gross_income * valuation_results.vacancy_rate) }}
                                                    <small class="text-muted">({{ "{:.1f}".format(valuation_results.vacancy_rate * 100) }}% vacancy rate)</small>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Effective Gross Income:</th>
                                                <td class="text-end">${{ "{:,.2f}".format(valuation_results.effective_gross_income) }}</td>
                                            </tr>
                                            <tr>
                                                <th>Operating Expenses:</th>
                                                <td class="text-end">- ${{ "{:,.2f}".format(valuation_results.effective_gross_income * valuation_results.expense_ratio) }}
                                                    <small class="text-muted">({{ "{:.1f}".format(valuation_results.expense_ratio * 100) }}% expense ratio)</small>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Net Operating Income:</th>
                                                <td class="text-end">${{ "{:,.2f}".format(valuation_results.net_operating_income) }}</td>
                                            </tr>
                                            <tr>
                                                <th colspan="2" class="table-secondary">Capitalization</th>
                                            </tr>
                                            <tr>
                                                <th>Capitalization Rate:</th>
                                                <td class="text-end">{{ "{:.2f}".format(valuation_results.cap_rate * 100) }}%</td>
                                            </tr>
                                            <tr>
                                                <th colspan="2" class="table-secondary">Adjustment Factors</th>
                                            </tr>
                                            {% if 'age_factor' in valuation_results %}
                                            <tr>
                                                <th>Age Factor:</th>
                                                <td class="text-end">{{ "{:.2f}".format(valuation_results.age_factor) }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if 'location_factor' in valuation_results %}
                                            <tr>
                                                <th>Location Factor:</th>
                                                <td class="text-end">{{ "{:.2f}".format(valuation_results.location_factor) }}</td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <th>Confidence Score:</th>
                                                <td class="text-end">{{ "{:.1f}".format(valuation_results.confidence_score * 100) }}%</td>
                                            </tr>
                                        </table>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i> The income approach is typically used for commercial and investment properties, and values a property based on its income-generating potential.
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> {{ valuation_results.error }}
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> This valuation is based on the {{ selected_approach }} approach with a confidence score of {{ valuation_results.confidence_score * 100 if valuation_results.confidence_score else 0 }}%.
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i> Enter property details and select a valuation approach to calculate the property value.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Valuation Approaches Info -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Valuation Approaches</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="valuationApproachesInfo">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="marketApproachHeading">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#marketApproachInfo" aria-expanded="true" aria-controls="marketApproachInfo">
                                    Market Comparison Approach
                                </button>
                            </h2>
                            <div id="marketApproachInfo" class="accordion-collapse collapse show" aria-labelledby="marketApproachHeading" data-bs-parent="#valuationApproachesInfo">
                                <div class="accordion-body">
                                    <p>Compares the subject property to similar properties that have recently sold in the same area. Adjustments are made for differences between the properties to arrive at a market value.</p>
                                    <p class="mb-0"><strong>Best for:</strong> Residential properties and properties in areas with active real estate markets.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="costApproachHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#costApproachInfo" aria-expanded="false" aria-controls="costApproachInfo">
                                    Cost Approach
                                </button>
                            </h2>
                            <div id="costApproachInfo" class="accordion-collapse collapse" aria-labelledby="costApproachHeading" data-bs-parent="#valuationApproachesInfo">
                                <div class="accordion-body">
                                    <p>Estimates the value by calculating the cost to replace the improvements, minus depreciation, plus the value of the land.</p>
                                    <p class="mb-0"><strong>Best for:</strong> New construction, special-purpose properties, and unique properties with few comparables.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="incomeApproachHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#incomeApproachInfo" aria-expanded="false" aria-controls="incomeApproachInfo">
                                    Income Approach
                                </button>
                            </h2>
                            <div id="incomeApproachInfo" class="accordion-collapse collapse" aria-labelledby="incomeApproachHeading" data-bs-parent="#valuationApproachesInfo">
                                <div class="accordion-body">
                                    <p>Determines value based on the income the property generates. Calculates the present value of future income using capitalization rates.</p>
                                    <p class="mb-0"><strong>Best for:</strong> Commercial and investment properties such as office buildings, retail centers, and apartment complexes.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if valuation_results %}
            {% if 'market_value' in valuation_results %}
                // Create market approach chart
                createMarketApproachChart('marketApproachChart', {{ valuation_results|tojson }});
            {% elif 'cost_value' in valuation_results %}
                // Create cost approach chart
                createCostApproachChart('costApproachChart', {{ valuation_results|tojson }});
            {% elif 'income_value' in valuation_results and valuation_results.income_value %}
                // Create income approach chart
                createIncomeApproachChart('incomeApproachChart', {{ valuation_results|tojson }});
            {% endif %}
        {% endif %}
        
        // Setup form validation
        const form = document.querySelector('.needs-validation');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        }
        
        // Show class codes when property class is selected
        const propertyClassSelect = document.getElementById('property_class');
        const classCodesDisplay = document.getElementById('class_codes_display');
        
        if (propertyClassSelect && classCodesDisplay) {
            propertyClassSelect.addEventListener('change', function() {
                const selectedClass = this.value;
                let codes = [];
                
                // Map class names to their codes (matching config.py)
                const classCodes = {
                    'Residential': ['R1', 'R2', 'R3', 'R4'],
                    'Commercial': ['C1', 'C2', 'C3'],
                    'Industrial': ['I1', 'I2', 'I3'],
                    'Agricultural': ['A1', 'A2'],
                    'Vacant Land': ['V1', 'V2'],
                    'Public': ['P1', 'P2']
                };
                
                if (selectedClass && classCodes[selectedClass]) {
                    codes = classCodes[selectedClass];
                    classCodesDisplay.textContent = `Includes codes: ${codes.join(', ')}`;
                    classCodesDisplay.classList.remove('d-none');
                } else {
                    classCodesDisplay.classList.add('d-none');
                }
            });
            
            // Trigger on page load if a value is selected
            if (propertyClassSelect.value) {
                propertyClassSelect.dispatchEvent(new Event('change'));
            }
        }
    });
    
    // Chart creation functions
    function createMarketApproachChart(canvasId, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Extract data for chart
        const marketValue = data.market_value;
        const baseValue = data.base_value;
        const adjustedValues = [];
        
        // Calculate different components of the final value
        adjustedValues.push(baseValue); // Base value
        
        // Calculate the incremental value from each adjustment
        let currentValue = baseValue;
        
        // Add market adjustment
        const marketAdjustment = baseValue * data.market_multiplier - baseValue;
        adjustedValues.push(currentValue + marketAdjustment);
        currentValue += marketAdjustment;
        
        // Add location adjustment
        const locationAdjustment = baseValue * data.location_multiplier - baseValue;
        adjustedValues.push(currentValue + locationAdjustment);
        currentValue += locationAdjustment;
        
        // Add age adjustment if present
        if (data.age_adjustment) {
            const ageAdjustment = baseValue * data.age_adjustment - baseValue;
            adjustedValues.push(currentValue + ageAdjustment);
            currentValue += ageAdjustment;
        }
        
        // Add size adjustment if present
        if (data.size_adjustment) {
            const sizeAdjustment = baseValue * data.size_adjustment - baseValue;
            adjustedValues.push(currentValue + sizeAdjustment);
            currentValue += sizeAdjustment;
        }
        
        // Add feature adjustment if present
        if (data.feature_adjustment) {
            const featureAdjustment = baseValue * data.feature_adjustment - baseValue;
            adjustedValues.push(currentValue + featureAdjustment);
        }
        
        // Create labels based on available adjustments
        const labels = ['Base Value', 'Market Adjustment', 'Location Adjustment'];
        if (data.age_adjustment) labels.push('Age Adjustment');
        if (data.size_adjustment) labels.push('Size Adjustment');
        if (data.feature_adjustment) labels.push('Feature Adjustment');
        
        // Create chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Value Progression',
                    data: adjustedValues,
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                    pointRadius: 4,
                    fill: true,
                    lineTension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Property Value ($)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '$' + context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Market Approach Value Progression'
                    }
                }
            }
        });
    }
    
    function createCostApproachChart(canvasId, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Extract data for chart
        const costValue = data.cost_value;
        const replacementCost = data.replacement_cost;
        const depreciation = replacementCost - data.depreciated_cost;
        const landValue = data.land_value;
        const functionalObsolescence = data.functional_obsolescence || 0;
        const externalObsolescence = data.external_obsolescence || 0;
        
        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Components'],
                datasets: [
                    {
                        label: 'Replacement Cost',
                        data: [replacementCost],
                        backgroundColor: 'rgba(255, 193, 7, 0.6)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Depreciation',
                        data: [-depreciation],
                        backgroundColor: 'rgba(220, 53, 69, 0.6)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Functional Obsolescence',
                        data: [-functionalObsolescence],
                        backgroundColor: 'rgba(253, 126, 20, 0.6)',
                        borderColor: 'rgba(253, 126, 20, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'External Obsolescence',
                        data: [-externalObsolescence],
                        backgroundColor: 'rgba(108, 117, 125, 0.6)',
                        borderColor: 'rgba(108, 117, 125, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Land Value',
                        data: [landValue],
                        backgroundColor: 'rgba(40, 167, 69, 0.6)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Property Value ($)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        stacked: true
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    // Show absolute value for negative components
                                    const value = Math.abs(context.parsed.y);
                                    label += '$' + value.toLocaleString();
                                }
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Cost Approach Components'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }
    
    function createIncomeApproachChart(canvasId, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Extract data for chart
        const potentialGrossIncome = data.potential_gross_income;
        const vacancyLoss = potentialGrossIncome * data.vacancy_rate;
        const effectiveGrossIncome = data.effective_gross_income;
        const operatingExpenses = effectiveGrossIncome * data.expense_ratio;
        const netOperatingIncome = data.net_operating_income;
        const capRate = data.cap_rate;
        const incomeValue = data.income_value;
        
        // Create waterfall chart data
        const labels = ['Potential Gross Income', 'Vacancy Loss', 'Effective Gross Income', 'Operating Expenses', 'Net Operating Income'];
        const values = [potentialGrossIncome, -vacancyLoss, effectiveGrossIncome, -operatingExpenses, netOperatingIncome];
        const colors = [
            'rgba(40, 167, 69, 0.7)', // Potential Gross Income (green)
            'rgba(220, 53, 69, 0.7)', // Vacancy Loss (red)
            'rgba(23, 162, 184, 0.7)', // Effective Gross Income (teal)
            'rgba(220, 53, 69, 0.7)', // Operating Expenses (red)
            'rgba(0, 123, 255, 0.7)'  // Net Operating Income (blue)
        ];
        const borderColors = [
            'rgba(40, 167, 69, 1)',
            'rgba(220, 53, 69, 1)',
            'rgba(23, 162, 184, 1)',
            'rgba(220, 53, 69, 1)',
            'rgba(0, 123, 255, 1)'
        ];
        
        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Amount ($)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.raw !== null) {
                                    // Show absolute value for negative components
                                    const value = Math.abs(context.raw);
                                    label += '$' + value.toLocaleString();
                                }
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Income Approach Components'
                    },
                    subtitle: {
                        display: true,
                        text: `Cap Rate: ${(capRate * 100).toFixed(2)}% â†’ Value: $${incomeValue.toLocaleString()}`,
                        padding: {
                            bottom: 10
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
